#!/usr/bin/env bash
set -euo pipefail

# pack — universal package manager wrapper
# Detects the system package manager and execs the right command.

# --- detect best system manager ---
detect() {
    for c in paru yay pacman apt dnf zypper apk xbps-install; do
        command -v "$c" &>/dev/null && echo "$c" && return
    done
}

# --- needs sudo? ---
needs_sudo() {
    case "$1" in
        paru|yay|apk|flatpak) return 1 ;;
        *) return 0 ;;
    esac
}

# --- maybe prepend sudo ---
run() {
    if needs_sudo "$MGR"; then
        exec "$@"
    else
        exec sudo "$@"
    fi
}

# --- run without sudo (search, list, details) ---
run_plain() {
    exec "$@"
}

# --- usage ---
usage() {
    cat <<'EOF'
pack — universal package manager wrapper

Usage:
  pack                  show this help
  pack -s QUERY         search for packages
  pack -i PKG           install a package
  pack -r PKG           remove a package
  pack -d PKG           show package details
  pack -l               list installed packages
  pack -u               update all packages
  pack -c               cleanup orphaned packages
  pack -h               show this help

  pack -m MGR ...       force a specific manager
                        e.g. pack -m flatpak -s firefox

Auto-detected managers (first found wins):
  paru, yay, pacman, apt, dnf, zypper, apk, xbps-install
EOF
}

# --- require argument helper ---
require_arg() {
    [[ -z "${1:-}" ]] && { printf '✗ %s requires an argument\n' "$2" >&2; exit 1; }
}

# --- parse args ---
MGR=""
ACTION="help"
ARG=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -s) ACTION=search;  require_arg "${2:-}" "-s"; ARG="$2"; shift 2 ;;
        -i) ACTION=install; require_arg "${2:-}" "-i"; ARG="$2"; shift 2 ;;
        -r) ACTION=remove;  require_arg "${2:-}" "-r"; ARG="$2"; shift 2 ;;
        -d) ACTION=details; require_arg "${2:-}" "-d"; ARG="$2"; shift 2 ;;
        -l) ACTION=list; shift ;;
        -u) ACTION=update; shift ;;
        -c) ACTION=cleanup; shift ;;
        -m) require_arg "${2:-}" "-m"; MGR="$2"; shift 2 ;;
        -h|--help) ACTION=help; shift ;;
        *)  printf '✗ Unknown option: %s\n' "$1" >&2; exit 1 ;;
    esac
done

[[ "$ACTION" == "help" ]] && { usage; exit 0; }

[[ -z "$MGR" ]] && MGR=$(detect)
[[ -z "$MGR" ]] && { printf '✗ No package manager found\n' >&2; exit 1; }

# --- dispatch ---
case "$MGR" in
    paru)
        case "$ACTION" in
            search)  run_plain paru -Ss "$ARG" ;;
            install) run paru -S --noconfirm "$ARG" ;;
            remove)  run paru -R "$ARG" ;;
            details) run_plain paru -Si "$ARG" ;;
            list)    run_plain paru -Q ;;
            update)  run paru -Syu --noconfirm ;;
            cleanup)
                orphans=$(paru -Qdtq 2>/dev/null) || true
                if [[ -n "$orphans" ]]; then
                    echo "$orphans" | paru -Rns -
                else
                    printf 'No orphaned packages found\n'
                fi
                ;;
        esac
        ;;
    yay)
        case "$ACTION" in
            search)  run_plain yay -Ss "$ARG" ;;
            install) run yay -S --noconfirm "$ARG" ;;
            remove)  run yay -R "$ARG" ;;
            details) run_plain yay -Si "$ARG" ;;
            list)    run_plain yay -Q ;;
            update)  run yay -Syu --noconfirm ;;
            cleanup)
                orphans=$(yay -Qdtq 2>/dev/null) || true
                if [[ -n "$orphans" ]]; then
                    echo "$orphans" | yay -Rns -
                else
                    printf 'No orphaned packages found\n'
                fi
                ;;
        esac
        ;;
    pacman)
        case "$ACTION" in
            search)  run_plain pacman -Ss "$ARG" ;;
            install) run pacman -S --noconfirm "$ARG" ;;
            remove)  run pacman -R "$ARG" ;;
            details) run_plain pacman -Si "$ARG" ;;
            list)    run_plain pacman -Q ;;
            update)  run pacman -Syu --noconfirm ;;
            cleanup)
                orphans=$(pacman -Qdtq 2>/dev/null) || true
                if [[ -n "$orphans" ]]; then
                    echo "$orphans" | sudo pacman -Rns -
                else
                    printf 'No orphaned packages found\n'
                fi
                ;;
        esac
        ;;
    apt)
        case "$ACTION" in
            search)  run_plain apt search "$ARG" ;;
            install) run apt install -y "$ARG" ;;
            remove)  run apt remove -y "$ARG" ;;
            details) run_plain apt show "$ARG" ;;
            list)    run_plain apt list --installed ;;
            update)  run apt upgrade -y ;;
            cleanup) run apt autoremove -y ;;
        esac
        ;;
    dnf)
        case "$ACTION" in
            search)  run_plain dnf search "$ARG" ;;
            install) run dnf install -y "$ARG" ;;
            remove)  run dnf remove -y "$ARG" ;;
            details) run_plain dnf info "$ARG" ;;
            list)    run_plain dnf list --installed ;;
            update)  run dnf upgrade -y ;;
            cleanup) run dnf autoremove -y ;;
        esac
        ;;
    zypper)
        case "$ACTION" in
            search)  run_plain zypper search "$ARG" ;;
            install) run zypper install -y "$ARG" ;;
            remove)  run zypper remove -y "$ARG" ;;
            details) run_plain zypper info "$ARG" ;;
            list)    run_plain zypper search --installed-only ;;
            update)  run zypper update -y ;;
            cleanup) run_plain zypper packages --orphaned ;;
        esac
        ;;
    apk)
        case "$ACTION" in
            search)  run_plain apk search "$ARG" ;;
            install) run apk add "$ARG" ;;
            remove)  run apk del "$ARG" ;;
            details) run_plain apk info "$ARG" ;;
            list)    run_plain apk list --installed ;;
            update)  run apk upgrade ;;
            cleanup) printf 'Cleanup is not supported for %s\n' "$MGR" ;;
        esac
        ;;
    xbps-install)
        case "$ACTION" in
            search)  run_plain xbps-query -Rs "$ARG" ;;
            install) run xbps-install -y "$ARG" ;;
            remove)  run xbps-remove -y "$ARG" ;;
            details) run_plain xbps-query -S "$ARG" ;;
            list)    run_plain xbps-query -l ;;
            update)  run xbps-install -Syu ;;
            cleanup) run xbps-remove -oy ;;
        esac
        ;;
    flatpak)
        case "$ACTION" in
            search)  run_plain flatpak search "$ARG" ;;
            install) run flatpak install -y "$ARG" ;;
            remove)  run flatpak uninstall -y "$ARG" ;;
            details) run_plain flatpak info "$ARG" ;;
            list)    run_plain flatpak list ;;
            update)  run flatpak update -y ;;
            cleanup) run flatpak uninstall --unused -y ;;
        esac
        ;;
    snap)
        case "$ACTION" in
            search)  run_plain snap find "$ARG" ;;
            install) run snap install "$ARG" ;;
            remove)  run snap remove "$ARG" ;;
            details) run_plain snap info "$ARG" ;;
            list)    run_plain snap list ;;
            update)  run snap refresh ;;
            cleanup) printf 'Cleanup is not supported for %s\n' "$MGR" ;;
        esac
        ;;
    *)
        printf '✗ Unsupported manager: %s\n' "$MGR" >&2; exit 1
        ;;
esac
